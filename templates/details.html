{% extends "base.html" %}

{% block title %}Confirm YouTube download – {{ video_info.title }}{% endblock %}

{% block extra_head %}
  <meta name="description" content="Download '{{ video_info.title }}' from YouTube as MP3 or MP4. Choose audio quality or video resolution and start the download in one click." />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "applicationCategory": "Multimedia",
    "name": "YouTube MP3 & MP4 Downloader",
    "description": "Web tool to convert YouTube videos like '{{ video_info.title }}' to MP3 or MP4.",
    "operatingSystem": "Web",
    "offers": {"@type": "Offer", "price": "0"}
  }
  </script>
{% endblock %}

{% block content %}
  <section class="card-elevated">
    <header class="mb-3">
      <p class="input-label mb-1">{{ t('details_selected_video') }}</p>
      <h2 class="h5 mb-1" style="color:#e5e7eb;">{{ video_info.title }}</h2>
      {% if video_info.uploader %}
        <p class="hero-subtitle mb-0" style="font-size:0.82rem;">{{ video_info.uploader }}</p>
      {% endif %}
    </header>

    <div class="row">
      <div class="col-md-4 mb-3 mb-md-0">
        <div class="rounded overflow-hidden" style="border-radius:12px; border:1px solid rgba(148,163,184,0.35);">
          <img src="{{ video_info.thumbnail }}" alt="Thumbnail for {{ video_info.title }}" class="img-fluid" loading="lazy" />
        </div>
        {% if video_info.duration %}
          <p class="mt-2 mb-0" style="font-size:0.8rem; color:#9ca3af;">Duration: {{ video_info.duration }} seconds</p>
        {% endif %}
      </div>

      <div class="col-md-8">
        <form action="/download" method="POST" id="downloadForm">
          <input type="hidden" id="youtube_url" name="youtube_url" value="{{ video_info.url }}" />

          <div class="form-row">
            <div class="form-group col-sm-6">
              <label for="format" class="input-label">{{ t('details_format') }}</label>
              <select class="form-control form-control-sm" id="format" name="format" aria-label="Choose output format">
                <option value="mp3">MP3 – Audio only</option>
                <option value="mp4">MP4 – Video</option>
              </select>
            </div>

            <div class="form-group col-sm-6">
              <label for="quality" class="input-label">{{ t('details_quality') }}</label>
              <select class="form-control form-control-sm" id="quality" name="quality" aria-label="Choose quality">
                <option value="192">192 kbps</option>
                <option value="256">256 kbps</option>
                <option value="320">320 kbps</option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center mt-2">
            <button type="submit" class="btn btn-primary-main mb-2 mb-md-0">
              {{ t('details_start') }}
            </button>
            <button type="button" onclick="window.location='/'" class="btn btn-secondary-ghost">
              {{ t('details_back') }}
            </button>
          </div>

          <p class="legal-disclaimer mb-0 mt-3">
            {{ t('details_note') }}
          </p>
        </form>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  if ('{{ video_info.duration }}' == 'None' || {{ video_info.duration or 0 }} > {{ max_duration_seconds }}) {
    alert('{{ t('alert_long_video') }}');
    window.location.href = '/';
  }

  function validateYouTubeUrl() {
    var url = document.getElementById('youtube_url').value;
    // shorts, watch, youtu.be 형식을 모두 허용하는 느슨한 검증
    var pattern = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/[a-zA-Z0-9_\-/?=&]+$/;
    return pattern.test(url);
  }

  // 포맷에 따라 품질 옵션 동적으로 변경 (오디오/비디오)
  function updateQualityOptions() {
    var format = document.getElementById('format').value;
    var qualitySelect = document.getElementById('quality');
    qualitySelect.innerHTML = '';

    if (format === 'mp3') {
      qualitySelect.insertAdjacentHTML('beforeend', '\
        <option value="192">192 kbps</option>\
        <option value="256">256 kbps</option>\
        <option value="320">320 kbps</option>\
      ');
    } else if (format === 'mp4') {
      qualitySelect.insertAdjacentHTML('beforeend', '\
        <option value="360p">360p</option>\
        <option value="720p">720p</option>\
      ');
    }
  }

  document.getElementById('format').addEventListener('change', updateQualityOptions);
  // 초기 로드 시 기본 옵션 세팅
  updateQualityOptions();

  const textDownloading = "{{ t('overlay_downloading') }}";
  const textConverting = "{{ t('overlay_converting') }}";
  const textComplete = "{{ t('overlay_complete') }}";
  const textFailed = "{{ t('overlay_failed') }}";

  function updateProgress(percent, phase) {
    const overlay = document.getElementById('overlay');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('overlay-text');
    overlay.style.display = 'flex';

    const p = Math.max(0, Math.min(100, percent || 0));
    progressBar.style.width = p + '%';

    if (phase === 'complete') {
      statusText.textContent = textComplete;
    } else if (phase === 'failed') {
      statusText.textContent = textFailed;
    } else if (phase === 'converting') {
      statusText.textContent = textConverting + ' ' + p.toFixed(1) + '%';
    } else {
      statusText.textContent = textDownloading + ' ' + p.toFixed(1) + '%';
    }
  }

  function checkDownloadStatus(jobId) {
    let visualPercent = 0;

    let interval = setInterval(function () {
      fetch(`/status/${jobId}`)
        .then(response => response.json())
        .then(data => {
          const backendPercent = data.percent || 0;
          const phase = data.phase || 'downloading';

          if (phase === 'downloading') {
            // 다운로드 단계에서는 서버가 주는 퍼센트를 그대로 사용 (0~50%)
            visualPercent = backendPercent;
          } else if (phase === 'converting') {
            // 변환 단계에서는 50~99% 사이에서 천천히 증가시키되,
            // 이미 서버 퍼센트가 더 크면 그 값을 따라간다.
            const target = Math.max(backendPercent, 99);
            visualPercent = Math.min(target, visualPercent + 2);
          }

          if (data.status === 'complete') {
            updateProgress(100, 'complete');
            window.location = '/serve_file';
            alert("{{ t('alert_download_ready') }}");
            hideOverlay();
            clearInterval(interval);
          } else if (data.status === 'failed') {
            updateProgress(visualPercent || backendPercent, 'failed');
            alert("{{ t('alert_download_failed') }}");
            hideOverlay();
            clearInterval(interval);
          } else {
            console.log('Download in progress...', phase, backendPercent, visualPercent);
            updateProgress(visualPercent || backendPercent, phase);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          hideOverlay();
          clearInterval(interval);
        });
    }, 3000);
  }

  $('#downloadForm').on('submit', function (e) {
    e.preventDefault();

    if (!validateYouTubeUrl()) {
      alert("{{ t('alert_invalid_url') }}");
      return false;
    }

    showOverlay();

    $.ajax({
      type: $(this).attr('method'),
      url: $(this).attr('action'),
      data: $(this).serialize(),
      success: function (response) {
        if (response.job_id) {
          checkDownloadStatus(response.job_id);
        } else {
          alert("{{ t('alert_download_error') }}");
          hideOverlay();
        }
      },
      error: function () {
        hideOverlay();
        alert("{{ t('alert_download_failed') }}");
      }
    });
  });

  function showOverlay() {
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
  }

  function hideOverlay() {
    const overlay = document.getElementById('overlay');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('overlay-text');
    overlay.style.display = 'none';
    progressBar.style.width = '0%';
    statusText.textContent = "{{ t('overlay_text') }}";
  }
</script>
{% endblock %}
